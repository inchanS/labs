<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>백엔드 - typescript-express 환경에서 jest 및 node 환경에 따라 dotenv 설정 분리 - inchan.dev</title><meta name="Description" content="Coding Projects: From Ideas to Execution"><meta property="og:title" content="백엔드 - typescript-express 환경에서 jest 및 node 환경에 따라 dotenv 설정 분리" />
<meta property="og:description" content="문제상황 TDD 방법론을 따라 프로젝트를 진행하려는데 Jest를 이용하여 test 코드를 작성하던 중,
한가지 문제를 마주한다.
test를 위한 DB는 그 조건에 따라 생성되고 삭제되어지는 특성상,
실제 개발환경에서의 DB와 test DB를 분리하기 위해서 local DB는 2가지로 나누어 세팅을 해야한다.
그런데 test를 실행할때마다 typeORM 세팅의 연결값을 매번 변경해줘야하는 문제가 상당히 번거로웠다. 고민하던 와중, cross-env라는 npm package를 알게되었고 이를 이용하여 상황에 따라 dotenv 설정값을 유동적으로 활용할 수 있도록 세팅을 구상해보았다.
요약.
JEST의 test파일 실행시 기존 DB를 사용함으로 인한 DB내부 데이터 오염문제 test용 DB 분리로 해결 test용 DB 분리 이후, npm run 실행 환경(dev, test, production)에 따른 DB 설정문제 개발간 서버를 돌릴때, test코드를 돌릴때마다 dev." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://inchan.dev/posts/202301230424/" /><meta property="og:image" content="https://inchan.dev/images/avatar.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-23T04:24:50+09:00" />
<meta property="article:modified_time" content="2023-01-23T04:24:50+09:00" /><meta property="og:site_name" content="inchan.dev" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://inchan.dev/images/avatar.png"/>

<meta name="twitter:title" content="백엔드 - typescript-express 환경에서 jest 및 node 환경에 따라 dotenv 설정 분리"/>
<meta name="twitter:description" content="문제상황 TDD 방법론을 따라 프로젝트를 진행하려는데 Jest를 이용하여 test 코드를 작성하던 중,
한가지 문제를 마주한다.
test를 위한 DB는 그 조건에 따라 생성되고 삭제되어지는 특성상,
실제 개발환경에서의 DB와 test DB를 분리하기 위해서 local DB는 2가지로 나누어 세팅을 해야한다.
그런데 test를 실행할때마다 typeORM 세팅의 연결값을 매번 변경해줘야하는 문제가 상당히 번거로웠다. 고민하던 와중, cross-env라는 npm package를 알게되었고 이를 이용하여 상황에 따라 dotenv 설정값을 유동적으로 활용할 수 있도록 세팅을 구상해보았다.
요약.
JEST의 test파일 실행시 기존 DB를 사용함으로 인한 DB내부 데이터 오염문제 test용 DB 분리로 해결 test용 DB 분리 이후, npm run 실행 환경(dev, test, production)에 따른 DB 설정문제 개발간 서버를 돌릴때, test코드를 돌릴때마다 dev."/>
<meta name="application-name" content="inchan.dev">
<meta name="apple-mobile-web-app-title" content="inchan.dev"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://inchan.dev/posts/202301230424/" /><link rel="prev" href="https://inchan.dev/posts/202301180430/" /><link rel="next" href="https://inchan.dev/posts/202301230429/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "백엔드 - typescript-express 환경에서 jest 및 node 환경에 따라 dotenv 설정 분리",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/inchan.dev\/posts\/202301230424\/"
        },"genre": "posts","keywords": "TypeScript, Express","wordcount":  989 ,
        "url": "https:\/\/inchan.dev\/posts\/202301230424\/","datePublished": "2023-01-23T04:24:50+09:00","dateModified": "2023-01-23T04:24:50+09:00","publisher": {
            "@type": "Organization",
            "name": "inchan"},"author": {
                "@type": "Person",
                "name": "inchan"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="inchan.dev"><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="inchan.dev"><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">백엔드 - typescript-express 환경에서 jest 및 node 환경에 따라 dotenv 설정 분리</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>inchan</a></span>&nbsp;<span class="post-category">included in <a href="/categories/back-end/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Back-End</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-01-23">2023-01-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;989 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#문제상황">문제상황</a>
      <ul>
        <li><a href="#project-tree">Project Tree</a></li>
      </ul>
    </li>
    <li><a href="#설정">설정</a>
      <ul>
        <li><a href="#cross-env--package-설치"><code>cross-env</code>  package 설치</a></li>
        <li><a href="#node-setting">node setting</a></li>
        <li><a href="#dotenv-분리">dotenv 분리</a></li>
        <li><a href="#jest-세팅">jest 세팅</a></li>
      </ul>
    </li>
    <li><a href="#추가--dotenv-분리로-morgan설정-역시-따로-분리-가능">추가 : dotenv 분리로 morgan설정 역시 따로 분리 가능</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="문제상황">문제상황</h2>
<p>TDD 방법론을 따라 프로젝트를 진행하려는데 Jest를 이용하여 test 코드를 작성하던 중,<br>
한가지 문제를 마주한다.<br>
 </p>
<p>test를 위한 DB는 그 조건에 따라 생성되고 삭제되어지는 특성상,<br>
실제 개발환경에서의 DB와 test DB를 분리하기 위해서 local DB는 2가지로 나누어 세팅을 해야한다.<br>
 </p>
<p>그런데 test를 실행할때마다 typeORM 세팅의 연결값을 매번 변경해줘야하는 문제가 상당히 번거로웠다. <br>
 </p>
<p>고민하던 와중,  cross-env라는 npm package를 알게되었고 이를 이용하여 상황에 따라 dotenv 설정값을 유동적으로 활용할 수 있도록 세팅을 구상해보았다.<br>
 </p>
<p>요약.</p>
<ol>
<li>JEST의 test파일 실행시 기존 DB를 사용함으로 인한 DB내부 데이터 오염문제
<ul>
<li>test용 DB 분리로 해결</li>
</ul>
</li>
<li>test용 DB 분리 이후, npm run 실행 환경(dev, test, production)에 따른 DB 설정문제
<ul>
<li>개발간 서버를 돌릴때, test코드를 돌릴때마다 dev.DB와 test.DB를 따로이 설정해줘야 하는 번거로움</li>
</ul>
</li>
<li>main.ts파일에서 cross-env 패키지를 사용하더라도 JEST- test 코드는 해당 파일을 사용하지 않기에 어떻게 환경설정을 분리시킬 수 있는가에 따른 고민
 </li>
</ol>
<h3 id="project-tree">Project Tree</h3>
<p>우선 현재 상황에서의 project folder Tree는 다음과 같다.<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// project Tree
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">├── .env
</span></span><span class="line"><span class="cl">├── jest.config.js
</span></span><span class="line"><span class="cl">├── package.json
</span></span><span class="line"><span class="cl">├── src
</span></span><span class="line"><span class="cl">│   ├── app.ts
</span></span><span class="line"><span class="cl">│   ├── controllers
</span></span><span class="line"><span class="cl">│   │   └── users.controller.ts
</span></span><span class="line"><span class="cl">│   ├── entities
</span></span><span class="line"><span class="cl">│   │   └── users.entity.ts
</span></span><span class="line"><span class="cl">│   ├── main.ts
</span></span><span class="line"><span class="cl">│   ├── middleware
</span></span><span class="line"><span class="cl">│   │   └── jwt.strategy.ts
</span></span><span class="line"><span class="cl">│   ├── models
</span></span><span class="line"><span class="cl">│   │   ├── index.ts
</span></span><span class="line"><span class="cl">│   │   ├── repositories.ts
</span></span><span class="line"><span class="cl">│   │   └── users.dao.ts
</span></span><span class="line"><span class="cl">│   ├── routes
</span></span><span class="line"><span class="cl">│   │   ├── index.route.ts
</span></span><span class="line"><span class="cl">│   │   └── users.route.ts
</span></span><span class="line"><span class="cl">│   ├── services
</span></span><span class="line"><span class="cl">│   │   └── users.service.ts
</span></span><span class="line"><span class="cl">│   ├── tests
</span></span><span class="line"><span class="cl">│   │   ├── setup-tests.ts
</span></span><span class="line"><span class="cl">│   │   └── users.test.ts
</span></span><span class="line"><span class="cl">│   ├── types
</span></span><span class="line"><span class="cl">│   │   └── global.d.ts
</span></span><span class="line"><span class="cl">│   └── utils
</span></span><span class="line"><span class="cl">│       └── util.ts
</span></span><span class="line"><span class="cl">└── tsconfig.json
</span></span></code></pre></div><p> </p>
<h2 id="설정">설정</h2>
<p>고민하며 생각했던 해결방안은 다음과 같다.</p>
<ol>
<li>일반적인 개발환경과 test를 위한 환경을 구분할 수 있는 특정값을 조건으로 할당</li>
<li>위에서 할당한 조건에 따라 node는 각기 다른 dotenv 파일을 참조하여 실행할 수 있도록 작성
 </li>
</ol>
<p>우선 1번을 구현하기 위해 cross-env 패키지를 이용하여 조건을 할당한다.<br>
 </p>
<h3 id="cross-env--package-설치"><code>cross-env</code>  package 설치</h3>
<p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm i -D dotenv cross-env
</span></span></code></pre></div><p> </p>
<p><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p><code>dev</code>  [^2]</p>
<ul>
<li>개발용을 위해 response에 따라 색상이 입혀진 축약된 로그를 출력.</li>
<li>status값이 빨간색이면 서버 에러코드, 노란색이면 클라이언트 에러 코드, 청록색은 리다이렉션 코드, 그외 코드는 컬러가 없다.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/ou2hvTT.png"
        data-srcset="https://i.imgur.com/ou2hvTT.png, https://i.imgur.com/ou2hvTT.png 1.5x, https://i.imgur.com/ou2hvTT.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/ou2hvTT.png"
        title="https://i.imgur.com/ou2hvTT.png" /></li>
</ul>
<p><code>combined</code></p>
<ul>
<li>배포환경에서 사용</li>
<li>불특정 다수가 접속하기 때문에 IP를 로그에 남겨줌</li>
</ul>
</div>
        </div>
    </div>
 </p>
<p>cli에서 명령어 입력시 정확한 입력에 주의한다.<br>
 </p>
<p><div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Warning<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><strong>crossenv 사건</strong>  [^1]<br>
노드와 npm 생태계를 떠들썩하게 만든 사건이 있었다. <br>
이름하여 ‘crossenv 사건’ 이다. <br>
사람들이 cross-env를 설치할 때 실수로 cross-env 대신 crossenv를 설치해서 발생했는데, crossenv는 사용자의 .env 파일에 들어 있는 키들을 해커에게 전송하는 악성 패키지였던 것이었다.<br>
다행히 문제를 발견한 즉시 패키지가 차단되어 피해가 크게 확산되지는 않았지만, 유명한 패키지를 설치하는 과정에 혼동을 야기해 해킹하려는 시도가 있었다는 점에서 충격적인 사건이었다. <br>
따라서 패키지를 설치할 때는 항상 주의를 기울여야 한다.</div>
        </div>
    </div>
 </p>
<h3 id="node-setting">node setting</h3>
<p>package.json 파일에서 명령어를 이용해 앞서 설치하였던 <code>cross-env</code> 패키지에서 사용할 NODE_ENV라는 이름으로 설정값을 세팅한다.  (이름은 다른걸로 해도 무방하다.)<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="c1">// package.json
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;scripts&#34;</span><span class="err">:</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;test&#34;</span><span class="p">:</span> <span class="s2">&#34;cross-env NODE_ENV=test jest --runInBand --detectOpenHandles --forceExit&#34;</span><span class="p">,</span>    
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;cross-env NODE_ENV=production node dist/main.js&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;dev&#34;</span><span class="p">:</span> <span class="s2">&#34;cross-env NODE_ENV=develop concurrently \&#34;npx tsc --watch\&#34; \&#34;nodemon -q dist/main.js\&#34;&#34;</span><span class="p">,</span>
</span></span></code></pre></div><p> </p>
<p>npm 명령 스크립트의 서두에 <code>cross-env NODE_ENV=&lt;KEY&gt;</code> 라는 방식으로 세팅을 해두면, 해당 명령이 실행될때 <code>NODE_ENV</code> 의 값이 앞서 언급한 조건으로서 process.env.NODE_ENV라는 dotenv의 내부 값으로 할당된다.<br>
 </p>
<p>예시&gt;<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm <span class="nb">test</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># NODE_ENV=test 라는 값으로 세팅되고 jest가 실행된다.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ npm run dev
</span></span><span class="line"><span class="cl"><span class="c1"># NODE_ENV=dev 라는 값으로 세팅되고 ts파일의 컴파일과 nodemon이 실행된다.</span>
</span></span></code></pre></div><p> </p>
<p>이렇게 스크립트단에서의 명령어에 세팅을 해두고 이제 해당 값에 따라 dotenv가 적용될 수 있게끔,<br>
설정파일의 분리를 진행한다.<br>
 <br>
 </p>
<h3 id="dotenv-분리">dotenv 분리</h3>
<p>우선 상황에 따른 dotenv 설정값을 별도로 작성한 파일을 만들어주는데,  root 폴더에서 파일을 그대로 두자니 지저분한것 같아 따로이 폴더를 만들어 그 안에 정리하였다.<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">├── env
</span></span><span class="line"><span class="cl">    ├── .env.dev
</span></span><span class="line"><span class="cl">    ├── .env.production
</span></span><span class="line"><span class="cl">    └── .env.test
</span></span></code></pre></div><p> </p>
<p>typrORM의 dotenv 설정을 아래 예시로 들어본다.<br>
차이점은,<br>
TYPEORM_DATABASE명에서 test용과 개발용을 구분하였고,<br>
TYPEORM_LOGGING의 경우 test환경에서는 필요가 없기에 false로 처리하였다.<br>
 </p>
<p>그리고 배포시에 쓰는 <code>.env.production</code> 파일에서는<br>
연결시마다  scheme 자동생성을 막기 위해 <code>TYPEORM_SYNCHRONIZE=FALSE</code> 처리를 해둔다.<br>
 </p>
<p>예시&gt;<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// env/.env.dev
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="nx">typeorm</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_CONNECTION</span><span class="o">=</span><span class="nx">mysql</span>
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_HOST</span><span class="o">=</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_USERNAME</span><span class="o">=</span><span class="nx">root</span>
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_PASSWORD</span><span class="o">=</span><span class="mi">1234</span><span class="err">&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_DATABASE</span><span class="o">=</span><span class="nx">project_abc</span>  <span class="c1">// &lt;- 여기
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">TYPEORM_PORT</span><span class="o">=</span><span class="mi">3306</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_LOGGING</span><span class="o">=</span><span class="nx">TRUE</span>  <span class="c1">// &lt;- 여기
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">TYPEORM_SYNCHRONIZE</span><span class="o">=</span><span class="nx">TRUE</span>
</span></span></code></pre></div><p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// env/.env.test
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_CONNECTION</span><span class="o">=</span><span class="nx">mysql</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_HOST</span><span class="o">=</span><span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_USERNAME</span><span class="o">=</span><span class="nx">root</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_PASSWORD</span><span class="o">=</span><span class="mi">1234</span>
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_DATABASE</span><span class="o">=</span><span class="nx">test_project_abc</span>  <span class="c1">// &lt;- 여기
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">TYPEORM_PORT</span><span class="o">=</span><span class="mi">3306</span>  
</span></span><span class="line"><span class="cl"><span class="nx">TYPEORM_LOGGING</span><span class="o">=</span><span class="nx">FALSE</span>  <span class="c1">// &lt;- 여기
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">TYPEORM_SYNCHRONIZE</span><span class="o">=</span><span class="nx">TRUE</span>
</span></span></code></pre></div><p> </p>
<p>그리고 끝으로 이제 앞에서 특정한 값을 실행시킬 수 있도록 <code>express</code>를 실행하는 파일(대개 main.ts)에서 아래와 같이 세팅을 한다. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// src/main.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">dotenv</span> <span class="kr">from</span> <span class="s1">&#39;dotenv&#39;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s1">&#39;path&#39;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span> <span class="nx">path</span>: <span class="kt">path.join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;/../env/.env.production&#39;</span><span class="p">)</span> <span class="p">});</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;develop&#39;</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span> <span class="nx">path</span>: <span class="kt">path.join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;/../env/.env.dev&#39;</span><span class="p">)</span> <span class="p">});</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;process.env.NODE_ENV is &#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span> <span class="nx">path</span>: <span class="kt">path.join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;/../env/.env.test&#39;</span><span class="p">)</span> <span class="p">});</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;process.env.NODE_ENV IS_NOT_SET!!&#39;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p> </p>
<p><code>console.log('process.env.NODE_ENV is ', process.env.NODE_ENV);  </code><br>
dev 설정시 따로 console.log를 찍어준 이유는 개발환경에서 dev설정이 제대로 먹히고 있는지 확인차 넣어줬다.   <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p> </p>
<h3 id="jest-세팅">jest 세팅</h3>
<p>exress를 돌릴때, 만약 app.ts와 main.ts(or index.ts)등으로 나누어 놓았다면, <code>process.env.NODE_ENV</code> 는 main.ts에 작성되기에 jest에서는 해당 설정이 적용되지 않는다.<br>
때문에 test 파일 실행시 test용 dotenv가 작동될 수 있도록 따로 세팅을 해주어야 한다.(파일명 확인)<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 최상단 root폴더에 jest.config.js 또는 jest.config.json 파일
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">setupFiles</span><span class="o">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;&lt;root&gt;/src/tests/setup-tests.ts&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl"><span class="p">],</span>
</span></span></code></pre></div><p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// setup-tests.ts (파일명은 jest.config에서 설정했던 값과 동일하기만 하면 되기에 임의로 정해도 된다.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">dotenv</span> <span class="kr">from</span> <span class="s1">&#39;dotenv&#39;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;&lt;root&gt;/env/.env.test&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p> </p>
<p>위에서 설명한 바와 같이 세팅을 하면, 이제 jest / test파일 실행시 해당 dotenv 설정이 작동한다.<br>
 </p>
<p>typeORM.intialize()를 사용한다면 여기에 더해 실행하고자 하는 test파일 내부에서 한가지 더 코드가 필요하다.<br>
 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// users.test.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataSource</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="kr">type</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TYPEORM_CONNECTION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">host</span>: <span class="kt">process.env.TYPEORM_HOST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">port</span>: <span class="kt">process.env.TYPEORM_PORT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">username</span>: <span class="kt">process.env.TYPEORM_USERNAME</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span>: <span class="kt">process.env.TYPEORM_PASSWORD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">database</span>: <span class="kt">process.env.TYPEORM_DATABASE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">entities</span><span class="o">:</span> <span class="p">[</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../**/*.entity.{js,ts}&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logging</span>: <span class="kt">process.env.TYPEORM_LOGGING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">synchronize</span>: <span class="kt">process.env.TYPEORM_SYNCHRONIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p> </p>
<p>jest에서는 코드가 돌아갈때, main.ts파일을 거치지 않기때문에 <code>typeorm</code>의 <code>DataSource</code> 코드가 돌기 전 이니셜라이징할 수 있도록 따로 준비가 필요하다.<br>
위와 같이 설정시, 앞서 설정했던 jest.config에 따라 intialize() 코드가 돌게되고 이후부터는 앞서 설명했던대로 함수와 명령들이 실행되게 된다.</p>
<hr>
<h2 id="추가--dotenv-분리로-morgan설정-역시-따로-분리-가능">추가 : dotenv 분리로 morgan설정 역시 따로 분리 가능</h2>
<p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//app.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">createApp</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">app</span>: <span class="kt">Express</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">(</span><span class="nx">corsOptions</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;develop&#39;</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">));</span>           <span class="c1">// &lt;- 이렇게
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="s1">&#39;combined&#39;</span><span class="p">));</span>      <span class="c1">// &lt;- 이렇게
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="nx">extended</span>: <span class="kt">false</span> <span class="p">}));</span>  
</span></span><span class="line"><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p> </p>
<p>express에서 log를 남겨주는 morgan의 옵션중 <code>dev</code>와 <code>combined</code> 가 있는데 이를 상황에 맞게 나눌 수 있다.<br>
 </p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p><code>dev</code>  [^2]</p>
<ul>
<li>개발용을 위해 response에 따라 색상이 입혀진 축약된 로그를 출력.</li>
<li>status값이 빨간색이면 서버 에러코드, 노란색이면 클라이언트 에러 코드, 청록색은 리다이렉션 코드, 그외 코드는 컬러가 없다.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/ou2hvTT.png"
        data-srcset="https://i.imgur.com/ou2hvTT.png, https://i.imgur.com/ou2hvTT.png 1.5x, https://i.imgur.com/ou2hvTT.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/ou2hvTT.png"
        title="https://i.imgur.com/ou2hvTT.png" /></li>
</ul>
<p><code>combined</code></p>
<ul>
<li>배포환경에서 사용</li>
<li>불특정 다수가 접속하기 때문에 IP를 로그에 남겨줌</li>
</ul>
</div>
        </div>
    </div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://velog.io/@dinb1242/Nest.js-dotenv-%EC%99%80-cross-env-%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%ED%99%98%EA%B2%BD-%EB%B3%84-%ED%99%98%EA%B2%BD-%EB%B3%80%EC%88%98-%EC%A7%80%EC%A0%95%ED%95%98%EA%B8%B0" target="_blank" rel="noopener noreffer ">Nest.js - Deprecated -  dotenv 와 cross-env 를 활용한 환경 별 환경 변수 지정하기</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>그리고 끝까지 본문을 읽으면 알겠지만 test용 dotenv설정은 따로이 jest세팅에서 진행하기에 사실,
<code>else if (process.env.NODE_ENV === 'test') { dotenv.config({ path: path.join(__dirname, '/../env/.env.test') });</code> 이 부분은 필요가 없다. 하지만 추후 다른 용도에서 응용을 위한 예시로써 남겨둔다.<br>
 <br>
 &#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-01-23</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/typescript/">TypeScript</a>,&nbsp;<a href="/tags/express/">Express</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/202301180430/" class="prev" rel="prev" title="error log - throw와 return"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>error log - throw와 return</a>
            <a href="/posts/202301230429/" class="next" rel="next" title="mac 터미널에서 폴더트리 구조 확인">mac 터미널에서 폴더트리 구조 확인<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">inchan</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":70},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"url","label":"Comment","lightTheme":"github-light","repo":"inchanS/blog-comments"}},"data":{"id-1":"inchan.dev","id-2":"inchan.dev"},"search":{"algoliaAppID":"MKTUFLRGZY","algoliaIndex":"index.ko","algoliaSearchKey":"bc96d1a4ccc0607599f169955ef3e728","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":75}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-F2GSKQJ0MP', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-F2GSKQJ0MP" async></script></body>
</html>
